<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Geteam : <%=pageTitle %></title>
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script>
    <%
      function getFormatDate(paramDate) {
        let date = new Date(paramDate);
        let year = date.getFullYear(); //yyyy 
        let month = (1 + date.getMonth()); //M
        month = month >= 10 ? month : '0' + month; //month 두자리로 저장 
        let day = date.getDate(); //d 
        day = day >= 10 ? day : '0' + day; //day 두자리로 저장 
        return year + '-' + month + '-' + day;
      }
    %>
    String.prototype.trim = function () {
      return this.replace(/(^\s*)|(\s*$)/gi, "");
    }

    function searchChk() {
      let sSet = document.frmSearch;
      let searchKey = document.getElementById("search").value;
      searchKey = searchKey.trim();

      if (!searchKey.value) {
        window.alert('검색하실 단어를 입력해주세요');
        document.getElementById("search").focus();
      } else if (searchKey.value.length <= 1) {
        window.alert('2글자 이상의 단어를 입력해주세요');
        document.getElementById("search").focus();
      } else {
        sSet.submit();
      }
    }

    function itemChk() {
      let pSet = document.frmItem;

      let doubleResult = document.getElementById("itemDoubleResult");
      let topicResult = document.getElementById("itemTopicResult");
      let titleResult = document.getElementById("itemTitleResult");

      if (pSet.writeWantNum.value == "") {
        doubleResult.innerHTML = "값을 입력해주세요";
        pSet.writeWantNum.focus();
      } else if (pSet.writeTopic.value == "") {
        doubleResult.innerHTML = "";
        topicResult.innerHTML = "주제를 입력해주세요";
        pSet.writeTopic.focus();
      } else if (pSet.writeTitle.value == "") {
        topicResult.innerHTML = "";
        titleResult.innerHTML = "제목을 입력해주세요";
        pSet.writeTitle.focus();
      } else {
        pSet.submit();
      }
    }

    function lengCounter() {
      document.getElementById("counter").innerHTML = document.getElementById("textarea").value.length;
    }

    function textLengCounter() {
      document.getElementById("textCounter").innerHTML = document.getElementById("text").value.length;
    }

    function notAlert() {
      alert('최대 작성 수 3개를 초과하셨습니다!');
    }
  </script>

</head>

<%
  const listLen = itemList.length;
  const totalPage = listLen % 10 === 0 ? listLen : listLen + 1;

  let endDay = new Date();
  let maxEndDay = new Date();

  endDay.setDate(endDay.getDate() + 7);
  endDay = getFormatDate(endDay);

  maxEndDay.setDate(maxEndDay.getDate() + 60);
  maxEndDay = getFormatDate(maxEndDay);
%>

<body data-spy="scroll" data-target=".navbar-collapse">
  <div class="culmn">
    <% include header %>
    <div class="container">
      <div class="row">
        <div class="col-sm-8 col-sm-offset-2">
          <ul class="nav nav-pills nav-fill nav-justified m-top-100" style="margin-bottom: 50px;">

            <li class="nav-item">
              <a class="nav-link" href="/board/<%= kind %>/list/develop" target="Self"
                style="color: #efdc05; font-size: 1.1rem;">개발</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/board/<%= kind %>/list/design" target="Self"
                style="color: #efdc05; font-size: 1.1rem;">디자인</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/board/<%= kind %>/list/etc" target="Self"
                style="color: #efdc05; font-size: 1.1rem;">etc</a>
            </li>

            <%
              if(kind === 'contest') {
            %>
              <li class="nav-item">
                <a class="nav-link" href="/board/<%= kind %>/list/idea" target="Self"
                  style="color: #efdc05; font-size: 1.1rem;">idea</a>
              </li>
            <%
              }
            %>
          </ul>
        </div>

        <div class="separator_auto"></div>

        <div class="col-sm-12">
          <div class="pageTitle text-center">
            <h4><%= pageTitle %></h4>

            <div class="separator_auto"></div>

            <div class="skill_bottom_item m-top-20">
              <h6>총 게시글 수&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="statistic-counter"><%= listLen %></span></h6>
            </div>
          </div>
        </div>

        <div class="col-sm-10 col-sm-offset-1">
          <div class="col-sm-10">
            <form name="frmSearch" method="post" action="board/<%= kind %>/list/search">
              <select name="searchList" class="form-control dropdown-toggle" data-toggle="dropdown"
                aria-expanded="false" style="width: 30%; display: inline-block;">
                <option value="subject">제목</option>
                <option value="content">내용</option>
                <option value="name">작성자</option>
              </select>

              <input type="search" class="form-control form_fifty" placeholder="Search" name="search"
                style="display: inline-block; width: 50%;">
              
              <button type="button" onClick="searchChk()" class="btn btn-primary" style="padding: 1.2em 1.5em;"><i
                  class="fa fa-search"></i></button>
            </form>
          </div>
        </div>

        <div class="col-sm-10 col-sm-offset-1 m-top-20">
          <div class="col-sm-3">
            <%
              if(userListNum >= 3) {
            %>
                <button onClick='notAlert()' class="home_btns form-control btn btn-primary">글쓰기</button>
            <%
              } else {
            %>
                <button type='button' class="home_btns form-control btn btn-primary" data-toggle="modal"
                  data-target="#modalItem">글쓰기</button>
            <%
              } 
            %>
          </div>
        </div>

        <%
          if (listLen === 0) {
        %>
          아무 아이템도 없다
        <%
          } else {
        %>
        <%
          for(let i = 0; i < itemList.length; i++) {
            let item = itemList[i];
            item.createdAt = getFormatDate(item.createdAt);
            item.updatedAt = getFormatDate(item.updatedAt);
            item.endDay = getFormatDate(item.endDay);
            item.content = item.content.replace(/(<([^>]+)>)/ig,"");

            const endDayTime = new Date(item.endDay.slice(0, 4), Number(item.endDay.slice(5, 7)) - 1, item.endDay.slice(8, 10)).getTime();
            const diffDate = Math.round(((endDayTime - new Date().getTime()) / 1000 / 60 / 60 / 24));

            if(diffDate > 0) {
        %>
            <a href='/board/<%= kind %>/view/<%= category %>' style='text-decoration: none;'>
              <div class='col-sm-6 m-top-10'>
                <div class='list'>
                  <span class='badge' style='padding-bottom: 5px; background: #efdc05; color: white; float:right'>
                    D - <%= diffDate %>
                  </span>
                  <span>No.<%= item.num %></span>
                  <span>작성자 | <%= item.mem %></span>
                  <span class='title' style='margin-top: 15px;'>[<%= item.topic %>] <%= item.title %></span>
                  <span class='content' style='margin-bottom: 23px;'><%= item.content %></span>
                  <span>신청일 | <%= item.createdAt %> ~ <%= item.endDay %></span>
                  <span>
                    신청현황 | <%= item.applyNum %> / <%= item.wantNum %>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    조회수 | <%= item.hit %>
                  </span>
                </div>
              </div>
            </a>
        <%
          } else {
        %>
        <%
          if(Math.abs(diffDate) < 10) { // 신청 마감일과 현재 날짜가 10일 이상 차이나면 아예 안보임
        %>
            <div class='col-sm-6 m-top-10'>
              <div class='not_list'>
                <span class='badge' style='padding-bottom: 5px; background: #efdc05; color: white; float:right'>
                  <%= Math.abs(diffDate) + '일 지남' %>
                </span>
                <span>No.<%= item.num %></span>
                <span>작성자 | <%= item.mem %>
                <span class='title' style='margin-top: 15px;'>[<%= item.topic %>] <%= item.title %></span> <!-- 주제, 제목 -->
                <span class='content' style='margin-bottom: 23px;'><%= item.content %></span>
                <span>신청 기간 | <%= item.createdAt %> ~ <%= item.endDay %>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
                <span style='float: left;'>
                  신청현황 | <%= item.applyNum %> / <%= item.wantNum %>
                  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                  조회수 | <%= item.hit %>
                </span>
              <%
                if(userId === item.mem){ //신청기간 지난 게시물의 삭제 버튼
              %>
                <form method="post" action="/board/<%= kind %>?_method=DELETE&itemId=<%= item._id %>">
                  <button type="submit" class="btn btn-primary_delete" style="position: absolute; right: 40px; bottom: 20px; padding: 1em 1em; border-radius: 50%;">
                    <i class='fa fa-trash text-primary'></i>
                  </button>
                </form>
              <%
                }
              %>
              </div>
            </div>
        <%
          } 
        %>
        <%
          } // end of if
        %>
        <%
          } // end of for
        %>
        <%
          }
        %>

        <div class="col-sm-4 col-sm-offset-4 text-center m-top-50">
          <nav aria-labesl="...">
            <div>
              <ul class="pagination pagination-lg">
                <%
                  if((page + 1) - 5 >= 1) {
                %>
                  <li class="page-item">
                    <a class="page-link" href="/board/<%= kind %>/list/<%= category %>?page=<%= (page + 1) - 5 %>"
                      style="background: rgb(247,247,247); color: #FF8489; border: 0;">&laquo;</a>
                  </li>
                <%
                  } else {
                %>
                  <li class="page-item disabled">
                    <a class="page-link" href="#"
                      style="background: rgb(247,247,247); color: #efdc05; border: 0;">&laquo;</a>
                  </li>
                <%
                  }
                %>

                <%
                  for (let j = page + 1; j < totalPage; j++) {
                %>
                  <%
                    if (page + 1 === j) {
                  %>
                    <li class="page-item active">
                      <a class="page-link" href="#"
                        style="background: rgb(247,247,247); color: #efdc05; border: 0;"><%= $i %></a>
                    </li>
                  <%
                    } else {
                  %>
                    <li class="page-item disabled">
                      <a class="page-link" href="/board/<%= kind %>/list/<%= category %>?page=<%= page %>"
                        style="background: rgb(247,247,247); color: #ff6863; border: 0;"><%= i %></a>
                    </li>
                  <%
                    }
                  %>
                <%
                  }
                %>

                <%
                  if((page + 1) + 5 <= totalPage) {
                %>
                  <li class="page-item">
                    <a class="page-link" href="/board/<%= kind %>/list/<%= category %>?page=<%= (page + 1) + 5 %>"
                      style="background: rgb(247,247,247); color: #ff6863; border: 0;">&raquo;</a>
                  </li>
                <%
                  } else {
                %>
                  <li class="page-item disabled">
                    <a class="page-link" href="#"
                      style="background: rgb(247,247,247); color: #efdc05; border: 0;">&raquo;</a>
                  </li>
                <%
                  }
                %>
              </ul>
            </div>
          </nav>
        </div>

      </div>
    </div>
    <% include footer %>
  </div>

  <div class="modal fade" id="modalItem" role="dialog">
    <div class="modal-dialog modal-lg modal-dialog-scrollable modal-dialog-centered">

      <div class="modal-content">

        <div class="modal-header">
          <h6 class="modal-title" style="display: inline-block;">
            <%= kind.charAt(0).toUpperCase() + kind.slice(1) %> Write
          </h6>
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div> <!-- modal header -->

        <form name="frmItem" class="form_write" method="post" action="/board/<%= kind %>">

          <div class="modal-body" style="padding: 50px;">
            <select class="form-control" name="writeKind">
              <option value="develop">개발</option>
              <option value="design">디자인</option>
              <%
                if (kind === 'contest') {
              %>
                <option value="idea">아이디어</option>
              <%
                }
              %>
              <option value="etc">기타</option>
            </select>
            <label>
              작성자
              <input type="text" class="form-control"
                value="<%= userId %> (<%= userName %>)" readonly>
              <input type="hidden" class="form-control" name="writeMem"
              value="<%= userId %>" readonly>
            </label>

            <label class="short" style="display: inline-block;">
              필요 인원
              <input type="number" name="writeWantNum">
            </label>

            <label class="short" style="display: inline-block; margin-left: 20px;">
              신청 마감일
              <input type="date" class="short" name="writeEndDay" value="<%= endDay %>" min="<%= endDay %>" max="<%= maxEndDay %>">
            </label>

            <span id="itemDoubleResult" class="fail"></span>

            <label>
              <% kind === 'study' ? '스터디' : '공모전' %> 주제
              <input type="text" name="writeTopic">
            </label>
            <span id="itemTopicResult" class="fail"></span>

            <div class="textareaCounter">
              <label>
                <% kind === 'study' ? '스터디' : '공모전' %> 제목
                <input type="text" id="text" name="writeTitle" maxlength="50" onkeyup="textLengCounter()">
                <span id="exCounter" class="counter">( <span id="textCounter" class="counter"></span> / 50 )</span>

              </label>
              <span id="itemTitleResult" class="fail"></span>
            </div>

            <script src="https://cdn.ckeditor.com/ckeditor5/12.2.0/classic/ckeditor.js"></script>
            <label>
              <% kind === 'study' ? '스터디' : '공모전' %> 소개 : 기간, 진행방식, 스터디 주제 설명, 주의사항 등을 자유롭게 적어주세요!
              <textarea name="writeContent" id="editor"></textarea>
            </label>
            <script>
              ClassicEditor
                .create(document.querySelector('#editor'))
                .catch(error => {
                  console.error(error);
                });
            </script>

          </div> <!-- modal body -->

          <div class="modal-footer">
            <div class="col-sm-3 col-sm-offset-9">
              <button type="button" onClick="itemChk()" class="form-control btn btn-primary">저장</button>
            </div>
          </div> <!-- modal footer -->

        </form>

      </div> <!-- modal content -->

    </div> <!-- modal-dialog -->
  </div> <!-- modal -->
</body>

</html>